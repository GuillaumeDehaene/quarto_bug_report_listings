% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrartcl}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\def\sumi{{\frac{1}{n} \sum_{i=1}^n}}
\KOMAoption{captions}{tableheading}
\makeatletter
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\usepackage{amsthm}
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[section]
\theoremstyle{remark}
\AtBeginDocument{\renewcommand*{\proofname}{Proof}}
\newtheorem*{remark}{Remark}
\newtheorem*{solution}{Solution}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[skins,breakable]{tcolorbox}}
\makeatother
\makeatletter
\@ifundefined{shadecolor}{\definecolor{shadecolor}{rgb}{.97, .97, .97}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\makeatother
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Listing 6 is bugged},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{Listing 6 is bugged}
\author{}
\date{}

\begin{document}
\maketitle
\begin{abstract}
This example document reports a bug about how Quarto numbered listings
are rendered by latex.

Since the bug is so fragile, I kept most of my original text. It's
unrelated to the bug, but I wasn't brave enough to replace everything
with Lorem Ipsum. Please ignore the content

\begin{verbatim}
- Please ignore the content
- Please ignore the content
- Please ignore the content
- Please ignore the content
- Please ignore the content
\end{verbatim}

Since the bug is so fragile, I kept most of my original text. It's
unrelated to the bug, but I wasn't brave enough to replace everything
with Lorem Ipsum. Please ignore the content
\end{abstract}
\ifdefined\Shaded\renewenvironment{Shaded}{\begin{tcolorbox}[enhanced, interior hidden, breakable, borderline west={3pt}{0pt}{shadecolor}, boxrule=0pt, sharp corners, frame hidden]}{\end{tcolorbox}}\fi

\hypertarget{listing-6-is-bugged}{%
\section{Listing 6 is bugged}\label{listing-6-is-bugged}}

\textbf{This document shows a bugged listing:
Listing~\ref{lst-bugged-listing}. Ignore the rest of the text.} Please
ignore the content

\begin{verbatim}
- Please ignore the content
- Please ignore the content
- Please ignore the content
- Please ignore the content
- Please ignore the content
\end{verbatim}

Since the bug is so fragile, I kept most of my original text. It's
unrelated to the bug, but I wasn't brave enough to replace everything
with Lorem Ipsum. Please ignore the content Since the bug is so fragile,
I kept most of my original text. It's unrelated to the bug, but I wasn't
brave enough to replace everything with Lorem Ipsum. Please ignore the
content Since the bug is so fragile, I kept most of my original text.
It's unrelated to the bug, but I wasn't brave enough to replace
everything with Lorem Ipsum. Please ignore the content

I wrote this document to illustrate what I believe to be the right
solution to these issues. This document does not aim to illustrate all
of Quarto's syntax. Please refer to
\href{https://quarto.org/docs/guide/}{the Quarto documentation instead}.
In Section~\ref{sec-empirical-statistics}, I present a simple example of
a math theorem and proof. In Section~\ref{sec-explanations}, I explain
how to solve the issues I encountered.

\begin{codelisting}

\caption{\texttt{document.qmd}}

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{{-}{-}{-}}
\FunctionTok{format}\KeywordTok{:}
\AttributeTok{  }\FunctionTok{html}\KeywordTok{:}
\KeywordTok{        {-} }\FunctionTok{text}\KeywordTok{:}\AttributeTok{ }\CharTok{|}
\NormalTok{            \textless{}script\textgreater{}}
\NormalTok{            MathJax = \{}
\NormalTok{                tex: \{}
\NormalTok{                    tags: \textquotesingle{}ams\textquotesingle{}  // should be \textquotesingle{}ams\textquotesingle{}, \textquotesingle{}none\textquotesingle{}, or \textquotesingle{}all\textquotesingle{}}
\NormalTok{                \}}
\NormalTok{            \};}
\NormalTok{            \textless{}/script\textgreater{}}
\PreprocessorTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\end{codelisting}

I wrote this document to illustrate what I believe to be the right
solution to these issues. This document does not aim to illustrate all
of Quarto's syntax. Please refer to
\href{https://quarto.org/docs/guide/}{the Quarto documentation instead}.
In Section~\ref{sec-empirical-statistics}, I present a simple example of
a math theorem and proof. In Section~\ref{sec-explanations}, I explain
how to solve the issues I encountered.

\hypertarget{sec-empirical-statistics}{%
\subsection{Empirical mean and
variance}\label{sec-empirical-statistics}}

Let \(x_i\) be a dataset of values of \(\mathbb{R}\). The empirical mean
\(m\) and variance \(v\) are defined as:

\begin{align}
m   &= \sumi x_i \\
v   &= \sumi (x_i - m)^2    \label{def-empirical-variance}
\end{align}

\begin{theorem}[]\protect\hypertarget{thm-label}{}\label{thm-label}

The empirical variance can also be written as:

\begin{equation}
\label{eq:a}
v = (\sumi x_i^2) - m^2
\end{equation}

\end{theorem}

\begin{codelisting}

\caption{\texttt{document.qmd}}

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{{-}{-}{-}}
\FunctionTok{format}\KeywordTok{:}
\AttributeTok{  }\FunctionTok{html}\KeywordTok{:}
\KeywordTok{        {-} }\FunctionTok{text}\KeywordTok{:}\AttributeTok{ }\CharTok{|}
\NormalTok{            \textless{}script\textgreater{}}
\NormalTok{            MathJax = \{}
\NormalTok{                tex: \{}
\NormalTok{                    tags: \textquotesingle{}ams\textquotesingle{}  // should be \textquotesingle{}ams\textquotesingle{}, \textquotesingle{}none\textquotesingle{}, or \textquotesingle{}all\textquotesingle{}}
\NormalTok{                \}}
\NormalTok{            \};}
\NormalTok{            \textless{}/script\textgreater{}}
\PreprocessorTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\end{codelisting}

\begin{proof}

The proof is straightforward: we start from the original definition in
eq.\eqref{def-empirical-variance} and expand the square.

\begin{align}
v   &= \sumi (x_i - m)^2 \\
    &= \sumi (x_i^2 - 2 x_i m + m^2) \\
    &= (\sumi x_i^2) - 2 (\sumi x_i) m + (\sumi 1) m^2 \\
    &= (\sumi x_i^2) - 2 m m + 1 m^2 \\
    &= (\sumi x_i^2) - m^2
\end{align}

This concludes the proof: we have indeed established the correctness of
eq.\eqref{eq:a}.

\end{proof}

\hypertarget{sec-explanations}{%
\subsection{Explanations}\label{sec-explanations}}

\hypertarget{numbering-equations-in-html}{%
\subsubsection{Numbering equations in
HTML}\label{numbering-equations-in-html}}

In a HTML document, equations are rendered by
\href{https://www.mathjax.org/}{MathJax}. By default, MathJax does not
number equations. In order to number equations, we need to modify the
MathJax configuration. A simple self-contained solution is to modify the
yaml preamble of the qmd file.

Please note, if your preamble becomes too complex, you can export it to
a separate file.

\begin{codelisting}

\caption{\texttt{document.qmd}}

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{{-}{-}{-}}
\FunctionTok{format}\KeywordTok{:}
\AttributeTok{  }\FunctionTok{html}\KeywordTok{:}
\KeywordTok{        {-} }\FunctionTok{text}\KeywordTok{:}\AttributeTok{ }\CharTok{|}
\NormalTok{            \textless{}script\textgreater{}}
\NormalTok{            MathJax = \{}
\NormalTok{                tex: \{}
\NormalTok{                    tags: \textquotesingle{}ams\textquotesingle{}  // should be \textquotesingle{}ams\textquotesingle{}, \textquotesingle{}none\textquotesingle{}, or \textquotesingle{}all\textquotesingle{}}
\NormalTok{                \}}
\NormalTok{            \};}
\NormalTok{            \textless{}/script\textgreater{}}
\PreprocessorTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\end{codelisting}

\begin{codelisting}

\caption{\texttt{document.qmd}}

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{{-}{-}{-}}
\FunctionTok{format}\KeywordTok{:}
\AttributeTok{  }\FunctionTok{html}\KeywordTok{:}
\KeywordTok{        {-} }\FunctionTok{text}\KeywordTok{:}\AttributeTok{ }\CharTok{|}
\NormalTok{            \textless{}script\textgreater{}}
\NormalTok{            MathJax = \{}
\NormalTok{                tex: \{}
\NormalTok{                    tags: \textquotesingle{}ams\textquotesingle{}  // should be \textquotesingle{}ams\textquotesingle{}, \textquotesingle{}none\textquotesingle{}, or \textquotesingle{}all\textquotesingle{}}
\NormalTok{                \}}
\NormalTok{            \};}
\NormalTok{            \textless{}/script\textgreater{}}
\PreprocessorTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\end{codelisting}

\hypertarget{macros}{%
\subsubsection{Macros}\label{macros}}

Macros are necessary when writing complex math, both to simplify the
source code and improve writing speed. It is tricky to define macros in
Quarto. My solution is to define macros in the yaml preamble,
hard-coding them in the premable of the html and tex file.

Please note that macros need to be wrote twice: once for html, once for
tex. This approach also makes the macros invisible for Quarto.

\begin{codelisting}

\caption{\texttt{document.qmd}}

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{{-}{-}{-}}
\FunctionTok{format}\KeywordTok{:}
\AttributeTok{    }\FunctionTok{pdf}\KeywordTok{:}
\AttributeTok{        }\FunctionTok{include{-}in{-}header}\KeywordTok{:}
\KeywordTok{            {-} }\FunctionTok{text}\KeywordTok{:}\AttributeTok{ }\CharTok{|}
\NormalTok{                \textbackslash{}def\textbackslash{}sumi\{\{\textbackslash{}frac\{1\}\{n\} \textbackslash{}sum\_\{i=1\}\^{}n\}\}}
\AttributeTok{    }\FunctionTok{html}\KeywordTok{:}
\AttributeTok{        }\FunctionTok{include{-}before{-}body}\KeywordTok{:}
\KeywordTok{            {-} }\FunctionTok{text}\KeywordTok{:}\AttributeTok{ }\CharTok{|}
\NormalTok{                $$}
\NormalTok{                    \textbackslash{}def\textbackslash{}sumi\{\{\textbackslash{}frac\{1\}\{n\} \textbackslash{}sum\_\{i=1\}\^{}n\}\}}
\NormalTok{                $$}

\PreprocessorTok{{-}{-}{-}}
\end{Highlighting}
\end{Shaded}

\end{codelisting}

\hypertarget{equation-cross-references}{%
\subsubsection{Equation
cross-references}\label{equation-cross-references}}

For equation cross-referencing, it is necessary to use the Latex
\texttt{\textbackslash{}label\{label\}} and
\texttt{\textbackslash{}eqref\{label\}} syntax, instead of the Quarto
\texttt{@label} syntax. For example:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{\textbackslash{}begin}\NormalTok{\{}\ExtensionTok{equation}\NormalTok{\}}
\SpecialStringTok{    1 + 1 = 2}
\SpecialCharTok{\textbackslash{}label}\SpecialStringTok{\{the\_equation\}}
\KeywordTok{\textbackslash{}end}\NormalTok{\{}\ExtensionTok{equation}\NormalTok{\}}

\NormalTok{Eq.}\KeywordTok{\textbackslash{}eqref}\NormalTok{\{}\ExtensionTok{the\_equation}\NormalTok{\} is much deeper than it appears.}
\end{Highlighting}
\end{Shaded}

Please note that figure and section cross-referencing should use Quarto
syntax.

Also note that, if you do not number all equations, then you need to
further add a \texttt{\textbackslash{}tag} command. Otherwise, in HTML
output, MathJax does not label the equation. The eqref then produces a
\texttt{???} href to the correct equation. For example:

\begin{codelisting}

\caption{This listing is bugged}

\hypertarget{lst-bugged-listing}{%
\label{lst-bugged-listing}}%
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{In this listing, the line marking}
\NormalTok{the end of the listing is not rendered}
\NormalTok{in the right position.}

\SpecialStringTok{$$ This line is inside the listing $$}
\end{Highlighting}
\end{Shaded}

\end{codelisting}

This text is outside the listing

The line above mixes:

\begin{itemize}
\tightlist
\item
  a normal text line: \texttt{This\ text\ is\ outside\ the\ listing}
\item
  a line from inside the code listing:
  \VERB|\AttributeTok{$$ This line is inside the listing $$}|
\end{itemize}

\begin{codelisting}

\caption{This listing is not bugged}

\hypertarget{lst-bugged-listing2}{%
\label{lst-bugged-listing2}}%
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{In this listing, the line marking}
\NormalTok{the end of the listing is not rendered}
\NormalTok{in the right position.}

\SpecialStringTok{$$ This line is inside the listing $$}
\end{Highlighting}
\end{Shaded}

\end{codelisting}

Some text outside the listing.



\end{document}
